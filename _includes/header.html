{% if site.github.owner %}
  {% assign user = site.github.owner %}
{% else %}
  {% assign user = site.author %}
{% endif %}
{% assign posts_total = site.posts | size %}

{% assign page_title = page.title | default: site.title %}
{% if page.title %}
  {% assign document_title = page.title | append: ' | ' | append: site.title %}
{% else %}
  {% assign document_title = site.title | append: ' - ' | append: site.description %}
{% endif %}

{% assign raw_description = page.description | default: page.excerpt | default: site.description %}
{% assign meta_description = raw_description | strip_html | strip_newlines | replace: '&nbsp;', ' ' | replace: '  ', ' ' | replace: '  ', ' ' | strip | truncate: 160 %}

{% assign meta_image_source = page.og_image | default: page.image | default: site.author.avatar | default: '/assets/favicon.svg' %}
{% if meta_image_source contains '://' %}
  {% assign meta_image = meta_image_source %}
{% else %}
  {% assign meta_image = meta_image_source | absolute_url %}
{% endif %}

{% assign og_type = 'website' %}
{% if page.layout == 'post' or page.collection == 'posts' %}
  {% assign og_type = 'article' %}
{% endif %}

{% assign author_title = site.author.title | default: '' %}
{% assign author_job_title = author_title %}
{% assign author_org = '' %}
{% if author_title contains ',' %}
  {% assign author_parts = author_title | split: ',' %}
  {% assign author_job_title = author_parts[0] | strip %}
  {% assign author_org = author_parts[1] | strip %}
{% endif %}

<!doctype html>
<html lang="{{ site.lang | default: 'en' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- SEO Meta Tags -->
    <title>{{ document_title | escape }}</title>
    <meta name="description" content="{{ meta_description | escape }}">
    <meta name="author" content="{{ site.author.name }}">
    <link rel="canonical" href="{{ page.url | absolute_url }}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="{{ og_type }}">
    <meta property="og:site_name" content="{{ site.title }}">
    <meta property="og:url" content="{{ page.url | absolute_url }}">
    <meta property="og:title" content="{{ page_title | escape }}">
    <meta property="og:description" content="{{ meta_description | escape }}">
    <meta property="og:image" content="{{ meta_image }}">
    <meta property="og:image:alt" content="{{ page_title | escape }}">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ page.url | absolute_url }}">
    <meta property="twitter:title" content="{{ page_title | escape }}">
    <meta property="twitter:description" content="{{ meta_description | escape }}">
    <meta property="twitter:image" content="{{ meta_image }}">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0366d6">
    <meta name="color-scheme" content="light dark">
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://github.com">
    
    <!-- Styles -->
    <link href="{{ '/assets/styles.css' | relative_url }}" rel="stylesheet" type="text/css">
    
    <!-- Favicon and icons -->
    <link rel="icon" href="{{ '/assets/favicon.svg' | relative_url }}" type="image/svg+xml">
    <link rel="icon" href="{{ '/favicon.ico' | relative_url }}" type="image/x-icon">
    <link rel="apple-touch-icon" href="{{ '/assets/favicon.svg' | relative_url }}">
    
    <!-- Schema.org structured data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "{{ site.author.name }}",
      "url": "{{ site.url | default: site.github.url | default: site.baseurl | absolute_url }}",
      "description": "{{ site.description | strip_html | strip_newlines | replace: '"', '\\"' }}",
      "image": "{{ meta_image }}",
      "jobTitle": "{{ author_job_title }}"{% if author_org != '' %},
      "worksFor": {
        "@type": "Organization",
        "name": "{{ author_org }}"
      }{% endif %}{% if site.author.email %},
      "email": "mailto:{{ site.author.email }}"{% endif %}{% if site.author.location %},
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "{{ site.author.location }}"
      }{% endif %},
      "knowsAbout": [
        {% if site.topics %}
          {% for topic in site.topics %}
            "{{ topic.name | replace: '"', '\\"' }}"{% unless forloop.last %},{% endunless %}
          {% endfor %}
        {% else %}
          "Quantum Chemistry",
          "High-Performance Computing",
          "Scientific Software"
        {% endif %}
      ],
      "sameAs": [
        {% assign same_as_count = 0 %}
        {% if site.social_media %}
          {% for account in site.social_media %}
            {% assign service_key = account[0] %}
            {% assign identifier = account[1] %}
            {% assign service = site.data.social_media[service_key] %}
            {% if service and identifier %}
              {% capture account_url %}
                {% if service_key == 'email' %}
                  mailto:{{ identifier }}
                {% else %}
                  {{ service.profile_url_prefix }}{{ identifier }}
                {% endif %}
              {% endcapture %}
              {% assign account_url = account_url | strip %}
              {% if account_url != '' %}
                {% if same_as_count > 0 %},{% endif %}"{{ account_url | replace: '"', '\\"' }}"
                {% assign same_as_count = same_as_count | plus: 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}
      ]
    }
    </script>
    
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
  </head>
  <body>
    {% include navigation.html %}
    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark/light theme" title="Toggle theme">
      <svg class="theme-toggle__icon theme-toggle__icon--sun" viewBox="0 0 24 24" width="20" height="20">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      <svg class="theme-toggle__icon theme-toggle__icon--moon" viewBox="0 0 24 24" width="20" height="20">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </button>

    <script>
      // Theme toggle functionality
      (function() {
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        
        // Get saved theme preference or default to system preference
        function getThemePreference() {
          const saved = localStorage.getItem('theme');
          if (saved) return saved;
          
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        
        // Apply theme
        function applyTheme(theme) {
          body.classList.remove('theme-light', 'theme-dark');
          body.classList.add(`theme-${theme}`);
          
          // Update toggle button state
          themeToggle.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} theme`);
          themeToggle.setAttribute('title', `Switch to ${theme === 'dark' ? 'light' : 'dark'} theme`);
        }
        
        // Initialize theme
        const currentTheme = getThemePreference();
        applyTheme(currentTheme);
        
        // Toggle theme
        themeToggle.addEventListener('click', function() {
          const isCurrentlyDark = body.classList.contains('theme-dark');
          const newTheme = isCurrentlyDark ? 'light' : 'dark';
          
          applyTheme(newTheme);
          localStorage.setItem('theme', newTheme);
        });
        
        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
          if (!localStorage.getItem('theme')) {
            applyTheme(e.matches ? 'dark' : 'light');
          }
        });
      })();
      
      // Page load animations
      document.addEventListener('DOMContentLoaded', function() {
        // Add fade-in class to main content areas
        const animatedElements = document.querySelectorAll('.section, .card, .project-card');
        
        animatedElements.forEach((element, index) => {
          element.classList.add('fade-in');
          if (index < 5) {
            element.classList.add(`stagger-${index + 1}`);
          }
        });
        
        // Intersection Observer for scroll animations
        if ('IntersectionObserver' in window) {
          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                entry.target.classList.add('slide-in');
                observer.unobserve(entry.target);
              }
            });
          }, {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
          });
          
          // Observe elements that should animate on scroll
          const scrollElements = document.querySelectorAll('.card:not(.fade-in), .project-card:not(.fade-in)');
          scrollElements.forEach(el => observer.observe(el));
        }
      });
    </script>
