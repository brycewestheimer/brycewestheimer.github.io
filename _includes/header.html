{% if site.github.owner %}
  {% assign user = site.github.owner %}
{% else %}
  {% assign user = site.author %}
{% endif %}
{% assign posts_total = site.posts | size %}

{% if page.path contains '_posts' %}
  {% assign page_title = page.title %}
  {% assign meta_description = page.content | strip_html | strip_newlines | xml_escape | truncate: 160 %}
{% else %}
  {% assign page_title = user.name %}
  {% assign meta_description = site.description | strip_html | strip_newlines | xml_escape | truncate: 160 %}
{% endif %}

<!doctype html>
<html lang="{{ site.lang | default: 'en' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- SEO Meta Tags -->
    <title>{% if page.title %}{{ page.title }} | {{ site.title }}{% else %}{{ site.title }} - {{ site.description }}{% endif %}</title>
    <meta name="description" content="{{ meta_description }}">
    <meta name="author" content="{{ site.author.name }}">
    <link rel="canonical" href="{{ page.url | absolute_url }}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ page.url | absolute_url }}">
    <meta property="og:title" content="{{ page_title }}">
    <meta property="og:description" content="{{ meta_description }}">
    <meta property="og:image" content="{% if user.avatar_url %}{{ user.avatar_url }}{% else %}{{ site.url }}/assets/favicon.svg{% endif %}">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ page.url | absolute_url }}">
    <meta property="twitter:title" content="{{ page_title }}">
    <meta property="twitter:description" content="{{ meta_description }}">
    <meta property="twitter:image" content="{% if user.avatar_url %}{{ user.avatar_url }}{% else %}{{ site.url }}/assets/favicon.svg{% endif %}">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0366d6">
    <meta name="color-scheme" content="light dark">
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://github.com">
    
    <!-- Styles -->
    <link href="{{ '/assets/styles.css' | relative_url }}" rel="stylesheet" type="text/css">
    
    <!-- Favicon and icons -->
    <link rel="icon" href="{{ '/assets/favicon.svg' | relative_url }}" type="image/svg+xml">
    <link rel="icon" href="{{ '/favicon.ico' | relative_url }}" type="image/x-icon">
    <link rel="apple-touch-icon" href="{{ '/assets/favicon.svg' | relative_url }}">
    
    <!-- Schema.org structured data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "{{ site.author.name }}",
      "url": "{{ site.url }}",
      "description": "{{ site.description }}",
      "jobTitle": "Postdoctoral Fellow",
      "worksFor": {
        "@type": "Organization",
        "name": "Computational Chemistry Research"
      },
      "alumniOf": "PhD in Chemistry",
      "knowsAbout": [
        "Quantum Chemistry",
        "High-Performance Computing", 
        "Machine Learning",
        "Software Development"
      ],
      "sameAs": [
        "https://github.com/{{ site.social_media.github }}",
        "https://linkedin.com/in/{{ site.social_media.linkedin }}",
        "https://scholar.google.com/citations?user={{ site.social_media.google_scholar }}"
      ]
    }
    </script>
    
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
  </head>
  <body>
    {% include navigation.html %}
    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark/light theme" title="Toggle theme">
      <svg class="theme-toggle__icon theme-toggle__icon--sun" viewBox="0 0 24 24" width="20" height="20">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      <svg class="theme-toggle__icon theme-toggle__icon--moon" viewBox="0 0 24 24" width="20" height="20">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </button>

    <script>
      // Theme toggle functionality
      (function() {
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        
        // Get saved theme preference or default to system preference
        function getThemePreference() {
          const saved = localStorage.getItem('theme');
          if (saved) return saved;
          
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        
        // Apply theme
        function applyTheme(theme) {
          body.classList.remove('theme-light', 'theme-dark');
          body.classList.add(`theme-${theme}`);
          
          // Update toggle button state
          themeToggle.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} theme`);
          themeToggle.setAttribute('title', `Switch to ${theme === 'dark' ? 'light' : 'dark'} theme`);
        }
        
        // Initialize theme
        const currentTheme = getThemePreference();
        applyTheme(currentTheme);
        
        // Toggle theme
        themeToggle.addEventListener('click', function() {
          const isCurrentlyDark = body.classList.contains('theme-dark');
          const newTheme = isCurrentlyDark ? 'light' : 'dark';
          
          applyTheme(newTheme);
          localStorage.setItem('theme', newTheme);
        });
        
        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
          if (!localStorage.getItem('theme')) {
            applyTheme(e.matches ? 'dark' : 'light');
          }
        });
      })();
      
      // Page load animations
      document.addEventListener('DOMContentLoaded', function() {
        // Add fade-in class to main content areas
        const animatedElements = document.querySelectorAll('.section, .card, .project-card, .repo-card');
        
        animatedElements.forEach((element, index) => {
          element.classList.add('fade-in');
          if (index < 5) {
            element.classList.add(`stagger-${index + 1}`);
          }
        });
        
        // Intersection Observer for scroll animations
        if ('IntersectionObserver' in window) {
          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                entry.target.classList.add('slide-in');
                observer.unobserve(entry.target);
              }
            });
          }, {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
          });
          
          // Observe elements that should animate on scroll
          const scrollElements = document.querySelectorAll('.card:not(.fade-in), .project-card:not(.fade-in)');
          scrollElements.forEach(el => observer.observe(el));
        }
      });
    </script>
